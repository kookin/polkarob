  ---
  - name: Deploy Polkadot Full Node
    hosts: polkadot_nodes
    become: yes
    become_method: sudo
    become_user: root
    gather_facts: true

    vars_files:
      - version.yaml

    vars:
      latest_version: "1.2.0"     # Please use this to specify the latest Polkadot sdk version

    tasks:  
      - name: Ansible task
        debug:
          msg: "Running Ansible task on host {{ inventory_hostname }}"

      - name: Update package cache and install dependencies
        apt:
          update_cache: yes
          force_apt_get: yes
          name: "{{ item }}"
        loop:
          - unzip
          - wget

      - name: Run Polkadot Version Check
        import_playbook: checkversion.yaml

      - name: Display Polkadot Version
        debug:
          msg: "Current Polkadot version is {{ polkadot_version }}"
        when: polkadot_version is defined

      - name: Notify if Polkadot Not Installed
        debug:
          msg: "Polkadot is currently not installed. Installing v1.0.0 and then running update to latest."
        when: polkadot_version is not defined

      - name: Create Polkadot user
        user:
          name: polkadot
          comment: "Polkadot Node User"
          system: true
          shell: /bin/bash

      - name: Create Polkadot data directory
        file:
          path: /var/lib/polkadot
          state: directory
          owner: polkadot
          group: polkadot

      - name: Download and extract v1.0.0 Polkadot binary
        shell: "wget https://github.com/paritytech/polkadot/releases/download/v1.0.0/polkadot -O /usr/local/bin/polkadot && chmod +x /usr/local/bin/polkadot"
        args:
          creates: /usr/local/bin/polkadot
        when: polkadot_version is not defined

      - name: Download and extract Polkadot update binary 1
        shell: "wget https://github.com/paritytech/polkadot-sdk/releases/download/polkadot-v{{ latest_version }}/polkadot -O /tmp/polkadot-update1.zip && unzip /tmp/polkadot-update1.zip -d /tmp/ && mv /tmp/{{ latest_version }}/polkadot /usr/local/bin/ && chmod +x /usr/local/bin/polkadot"
        when: polkadot_version is defined and polkadot_version | version_compare(latest_version, '<')

      - name: Download and extract Polkadot update binary 2
        shell: "wget https://github.com/paritytech/polkadot-sdk/releases/download/polkadot-v{{ latest_version }}/polkadot-execute-worker -O /tmp/polkadot-update2.zip && unzip /tmp/polkadot-update2.zip -d /tmp/ && mv /tmp/{{ latest_version }}/polkadot-execute-worker /usr/local/bin/ && chmod +x /usr/local/bin/polkadot"
        when: polkadot_version is defined and polkadot_version | version_compare(latest_version, '<')

      - name: Download and extract Polkadot update binary 3
        shell: "wget https://github.com/paritytech/polkadot-sdk/releases/download/polkadot-v{{ latest_version }}/polkadot-prepare-worker -O /tmp/polkadot-update3.zip && unzip /tmp/polkadot-update3.zip -d /tmp/ && mv /tmp/{{ latest_version }}/polkadot-prepare-worker /usr/local/bin/ && chmod +x /usr/local/bin/polkadot"
        when: polkadot_version is defined and polkadot_version | version_compare(latest_version, '<')

      - name: Start Polkadot
        command: "/usr/local/bin/polkadot --name 'polkadot-node{{ inventory_hostname }}' --validator"
        async: 0  
        poll: 0 

      - name: Configure Polkadot service
        template:
          src: polkadot.service.j2
          dest: /etc/systemd/system/polkadot.service
        notify: Reload Polkadot Service

      - name: Start and enable Polkadot service
        systemd:
          name: polkadot
          state: started
          enabled: yes

    handlers:
      - name: Reload Polkadot Service
        systemd:
          name: polkadot
          state: reloaded
